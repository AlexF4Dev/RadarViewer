class RadarLayer extends Layer {
    constructor(archive, product) {
        super()
        this.archive = archive;
        this.product = product
        this.refColor = `
        Units: DBZ
        Step: 5

        color: 0 0 0 0
        color: 5 29 100 146
        color: 10 85 171 235
        color: 15 109 184 140
        color: 20 73 169 86
        color: 25 37 146 41
        color: 30 42 101 17
        color: 35 241 234 56
        color: 40 237 176 44
        color: 45 182 18 11
        color: 50 224 62 16
        color: 60 116 39 129
        color: 65 143 111 146
        color: 80 255 255 255
        `
        this.velColor = `
        product: VEL
        units: MPH
        step: 10
        scale: 2.237

        color: -120 255 0 128
        color: -90.5 0 0 160
        color: -70 0 224 255
        color: -60 0 255 225
        color: -50 160 255 208
        color: -40 0 255 0
        color: -10 16 96 16
        color: -9.99 16 96 16
        color: -.01 112 128 112


        color: 0 144 128 144
        color: 10 112 0 0
        color: 40 255 0 0
        color: 48.6 255 0 128
        color: 49.5 255 0 144
        color: 69.99 255 196 255
        color: 70 255 96 0
        color: 120 255 255 0

        RF: 128 0 208
        `
        this.corColor = `
        product: RHO

        color: 0.0 0.0 0.0 127.5
        color: 0.00392156862745098 0.0 0.0 132.04545454545453
        color: 0.00784313725490196 0.0 0.0 136.5909090909091
        color: 0.011764705882352941 0.0 0.0 141.13636363636363
        color: 0.01568627450980392 0.0 0.0 145.6818181818182
        color: 0.0196078431372549 0.0 0.0 150.22727272727272
        color: 0.023529411764705882 0.0 0.0 154.77272727272728
        color: 0.027450980392156862 0.0 0.0 159.3181818181818
        color: 0.03137254901960784 0.0 0.0 163.86363636363635
        color: 0.03529411764705882 0.0 0.0 168.4090909090909
        color: 0.0392156862745098 0.0 0.0 172.95454545454544
        color: 0.043137254901960784 0.0 0.0 177.5
        color: 0.047058823529411764 0.0 0.0 182.04545454545453
        color: 0.050980392156862744 0.0 0.0 186.5909090909091
        color: 0.054901960784313725 0.0 0.0 191.13636363636363
        color: 0.058823529411764705 0.0 0.0 195.68181818181816
        color: 0.06274509803921569 0.0 0.0 200.22727272727272
        color: 0.06666666666666667 0.0 0.0 204.77272727272725
        color: 0.07058823529411765 0.0 0.0 209.3181818181818
        color: 0.07450980392156863 0.0 0.0 213.86363636363635
        color: 0.0784313725490196 0.0 0.0 218.4090909090909
        color: 0.08235294117647059 0.0 0.0 222.95454545454544
        color: 0.08627450980392157 0.0 0.0 227.49999999999997
        color: 0.09019607843137255 0.0 0.0 232.04545454545453
        color: 0.09411764705882353 0.0 0.0 236.59090909090907
        color: 0.09803921568627451 0.0 0.0 241.13636363636363
        color: 0.10196078431372549 0.0 0.0 245.68181818181816
        color: 0.10588235294117647 0.0 0.0 250.22727272727272
        color: 0.10980392156862745 0.0 0.0 254.77272727272725
        color: 0.11372549019607843 0.0 0.0 255.0
        color: 0.11764705882352941 0.0 0.0 255.0
        color: 0.12156862745098039 0.0 0.0 255.0
        color: 0.12549019607843137 0.0 0.5 255.0
        color: 0.12941176470588237 0.0 4.499999999999972 255.0
        color: 0.13333333333333333 0.0 8.5 255.0
        color: 0.13725490196078433 0.0 12.5 255.0
        color: 0.1411764705882353 0.0 16.5 255.0
        color: 0.1450980392156863 0.0 20.49999999999997 255.0
        color: 0.14901960784313725 0.0 24.5 255.0
        color: 0.15294117647058825 0.0 28.5 255.0
        color: 0.1568627450980392 0.0 32.5 255.0
        color: 0.1607843137254902 0.0 36.49999999999997 255.0
        color: 0.16470588235294117 0.0 40.5 255.0
        color: 0.16862745098039217 0.0 44.5 255.0
        color: 0.17254901960784313 0.0 48.5 255.0
        color: 0.17647058823529413 0.0 52.49999999999997 255.0
        color: 0.1803921568627451 0.0 56.5 255.0
        color: 0.1843137254901961 0.0 60.5 255.0
        color: 0.18823529411764706 0.0 64.5 255.0
        color: 0.19215686274509805 0.0 68.49999999999997 255.0
        color: 0.19607843137254902 0.0 72.5 255.0
        color: 0.2 0.0 76.5 255.0
        color: 0.20392156862745098 0.0 80.5 255.0
        color: 0.20784313725490197 0.0 84.49999999999997 255.0
        color: 0.21176470588235294 0.0 88.5 255.0
        color: 0.21568627450980393 0.0 92.5 255.0
        color: 0.2196078431372549 0.0 96.5 255.0
        color: 0.2235294117647059 0.0 100.49999999999997 255.0
        color: 0.22745098039215686 0.0 104.5 255.0
        color: 0.23137254901960785 0.0 108.5 255.0
        color: 0.23529411764705882 0.0 112.5 255.0
        color: 0.23921568627450981 0.0 116.49999999999997 255.0
        color: 0.24313725490196078 0.0 120.5 255.0
        color: 0.24705882352941178 0.0 124.5 255.0
        color: 0.25098039215686274 0.0 128.5 255.0
        color: 0.2549019607843137 0.0 132.5 255.0
        color: 0.25882352941176473 0.0 136.49999999999994 255.0
        color: 0.2627450980392157 0.0 140.5 255.0
        color: 0.26666666666666666 0.0 144.5 255.0
        color: 0.27058823529411763 0.0 148.5 255.0
        color: 0.27450980392156865 0.0 152.5 255.0
        color: 0.2784313725490196 0.0 156.5 255.0
        color: 0.2823529411764706 0.0 160.5 255.0
        color: 0.28627450980392155 0.0 164.5 255.0
        color: 0.2901960784313726 0.0 168.49999999999994 255.0
        color: 0.29411764705882354 0.0 172.5 255.0
        color: 0.2980392156862745 0.0 176.5 255.0
        color: 0.30196078431372547 0.0 180.5 255.0
        color: 0.3058823529411765 0.0 184.5 255.0
        color: 0.30980392156862746 0.0 188.5 255.0
        color: 0.3137254901960784 0.0 192.5 255.0
        color: 0.3176470588235294 0.0 196.5 255.0
        color: 0.3215686274509804 0.0 200.49999999999994 255.0
        color: 0.3254901960784314 0.0 204.5 255.0
        color: 0.32941176470588235 0.0 208.5 255.0
        color: 0.3333333333333333 0.0 212.5 255.0
        color: 0.33725490196078434 0.0 216.5 255.0
        color: 0.3411764705882353 0.0 220.5 254.03225806451613
        color: 0.34509803921568627 0.0 224.5 250.80645161290326
        color: 0.34901960784313724 0.0 228.5 247.58064516129033
        color: 0.35294117647058826 2.4193548387096313 232.49999999999994 244.35483870967747
        color: 0.3568627450980392 5.645161290322579 236.5 241.12903225806454
        color: 0.3607843137254902 8.870967741935482 240.5 237.90322580645162
        color: 0.36470588235294116 12.096774193548386 244.5 234.67741935483872
        color: 0.3686274509803922 15.322580645161288 248.5 231.45161290322582
        color: 0.37254901960784315 18.54838709677419 252.5 228.2258064516129
        color: 0.3764705882352941 21.774193548387093 255.0 225.0
        color: 0.3803921568627451 24.999999999999996 255.0 221.7741935483871
        color: 0.3843137254901961 28.225806451612854 255.0 218.54838709677426
        color: 0.38823529411764707 31.4516129032258 255.0 215.3225806451613
        color: 0.39215686274509803 34.677419354838705 255.0 212.09677419354838
        color: 0.396078431372549 37.90322580645161 255.0 208.8709677419355
        color: 0.4 41.129032258064505 255.0 205.6451612903226
        color: 0.403921568627451 44.354838709677416 255.0 202.4193548387097
        color: 0.40784313725490196 47.58064516129031 255.0 199.1935483870968
        color: 0.4117647058823529 50.80645161290322 255.0 195.96774193548387
        color: 0.41568627450980394 54.03225806451608 255.0 192.74193548387103
        color: 0.4196078431372549 57.258064516129025 255.0 189.51612903225805
        color: 0.4235294117647059 60.48387096774193 255.0 186.29032258064518
        color: 0.42745098039215684 63.70967741935483 255.0 183.06451612903228
        color: 0.43137254901960786 66.93548387096773 255.0 179.83870967741936
        color: 0.43529411764705883 70.16129032258063 255.0 176.61290322580646
        color: 0.4392156862745098 73.38709677419354 255.0 173.38709677419354
        color: 0.44313725490196076 76.61290322580645 255.0 170.16129032258064
        color: 0.4470588235294118 79.8387096774193 255.0 166.93548387096777
        color: 0.45098039215686275 83.06451612903224 255.0 163.70967741935485
        color: 0.4549019607843137 86.29032258064514 255.0 160.48387096774195
        color: 0.4588235294117647 89.51612903225806 255.0 157.25806451612902
        color: 0.4627450980392157 92.74193548387096 255.0 154.03225806451613
        color: 0.4666666666666667 95.96774193548386 255.0 150.80645161290323
        color: 0.47058823529411764 99.19354838709675 255.0 147.58064516129033
        color: 0.4745098039215686 102.41935483870967 255.0 144.35483870967744
        color: 0.47843137254901963 105.64516129032252 255.0 141.12903225806457
        color: 0.4823529411764706 108.87096774193547 255.0 137.90322580645162
        color: 0.48627450980392156 112.09677419354837 255.0 134.6774193548387
        color: 0.49019607843137253 115.32258064516127 255.0 131.45161290322582
        color: 0.49411764705882355 118.54838709677418 255.0 128.22580645161293
        color: 0.4980392156862745 121.77419354838707 255.0 125.00000000000001
        color: 0.5019607843137255 124.99999999999999 255.0 121.77419354838709
        color: 0.5058823529411764 128.2258064516129 255.0 118.5483870967742
        color: 0.5098039215686274 131.4516129032258 255.0 115.3225806451613
        color: 0.5137254901960784 134.6774193548387 255.0 112.09677419354838
        color: 0.5176470588235295 137.9032258064515 255.0 108.87096774193559
        color: 0.5215686274509804 141.12903225806448 255.0 105.64516129032258
        color: 0.5254901960784314 144.3548387096774 255.0 102.41935483870967
        color: 0.5294117647058824 147.58064516129028 255.0 99.19354838709678
        color: 0.5333333333333333 150.8064516129032 255.0 95.96774193548387
        color: 0.5372549019607843 154.03225806451613 255.0 92.74193548387096
        color: 0.5411764705882353 157.258064516129 255.0 89.51612903225808
        color: 0.5450980392156862 160.48387096774192 255.0 86.29032258064515
        color: 0.5490196078431373 163.7096774193548 255.0 83.06451612903227
        color: 0.5529411764705883 166.93548387096772 255.0 79.83870967741936
        color: 0.5568627450980392 170.16129032258064 255.0 76.61290322580645
        color: 0.5607843137254902 173.3870967741935 255.0 73.38709677419357
        color: 0.5647058823529412 176.61290322580643 255.0 70.16129032258064
        color: 0.5686274509803921 179.8387096774193 255.0 66.93548387096773
        color: 0.5725490196078431 183.06451612903223 255.0 63.70967741935485
        color: 0.5764705882352941 186.29032258064515 255.0 60.483870967741936
        color: 0.5803921568627451 189.51612903225794 255.0 57.25806451612913
        color: 0.5843137254901961 192.74193548387095 255.0 54.032258064516135
        color: 0.5882352941176471 195.96774193548384 255.0 50.80645161290322
        color: 0.592156862745098 199.19354838709674 255.0 47.580645161290334
        color: 0.596078431372549 202.41935483870967 255.0 44.35483870967742
        color: 0.6 205.64516129032253 255.0 41.129032258064505
        color: 0.6039215686274509 208.87096774193546 255.0 37.90322580645162
        color: 0.6078431372549019 212.09677419354836 255.0 34.67741935483871
        color: 0.611764705882353 215.32258064516125 255.0 31.451612903225794
        color: 0.615686274509804 218.54838709677418 255.0 28.22580645161291
        color: 0.6196078431372549 221.77419354838705 255.0 24.999999999999996
        color: 0.6235294117647059 224.99999999999997 255.0 21.77419354838711
        color: 0.6274509803921569 228.22580645161287 255.0 18.548387096774196
        color: 0.6313725490196078 231.45161290322577 255.0 15.322580645161283
        color: 0.6352941176470588 234.6774193548387 255.0 12.096774193548399
        color: 0.6392156862745098 237.9032258064516 255.0 8.870967741935484
        color: 0.6431372549019608 241.1290322580644 252.0370370370372 5.645161290322684
        color: 0.6470588235294118 244.35483870967738 248.33333333333337 2.419354838709685
        color: 0.6509803921568628 247.58064516129028 244.62962962962968 0.0
        color: 0.6549019607843137 250.8064516129032 240.92592592592598 0.0
        color: 0.6588235294117647 254.0322580645161 237.22222222222229 0.0
        color: 0.6627450980392157 255.0 233.51851851851856 0.0
        color: 0.6666666666666666 255.0 229.81481481481487 0.0
        color: 0.6705882352941176 255.0 226.11111111111117 0.0
        color: 0.6745098039215687 255.0 222.40740740740748 0.0
        color: 0.6784313725490196 255.0 218.70370370370375 0.0
        color: 0.6823529411764706 255.0 215.00000000000006 0.0
        color: 0.6862745098039216 255.0 211.29629629629636 0.0
        color: 0.6901960784313725 255.0 207.59259259259264 0.0
        color: 0.6941176470588235 255.0 203.88888888888894 0.0
        color: 0.6980392156862745 255.0 200.18518518518525 0.0
        color: 0.7019607843137254 255.0 196.48148148148155 0.0
        color: 0.7058823529411765 255.0 192.77777777777794 0.0
        color: 0.7098039215686275 255.0 189.07407407407416 0.0
        color: 0.7137254901960784 255.0 185.37037037037044 0.0
        color: 0.7176470588235294 255.0 181.66666666666674 0.0
        color: 0.7215686274509804 255.0 177.962962962963 0.0
        color: 0.7254901960784313 255.0 174.2592592592593 0.0
        color: 0.7294117647058823 255.0 170.5555555555556 0.0
        color: 0.7333333333333333 255.0 166.8518518518519 0.0
        color: 0.7372549019607844 255.0 163.1481481481482 0.0
        color: 0.7411764705882353 255.0 159.4444444444445 0.0
        color: 0.7450980392156863 255.0 155.7407407407408 0.0
        color: 0.7490196078431373 255.0 152.0370370370371 0.0
        color: 0.7529411764705882 255.0 148.33333333333337 0.0
        color: 0.7568627450980392 255.0 144.62962962962968 0.0
        color: 0.7607843137254902 255.0 140.92592592592598 0.0
        color: 0.7647058823529411 255.0 137.22222222222229 0.0
        color: 0.7686274509803922 255.0 133.51851851851868 0.0
        color: 0.7725490196078432 255.0 129.8148148148149 0.0
        color: 0.7764705882352941 255.0 126.11111111111116 0.0
        color: 0.7803921568627451 255.0 122.40740740740746 0.0
        color: 0.7843137254901961 255.0 118.70370370370377 0.0
        color: 0.788235294117647 255.0 115.00000000000004 0.0
        color: 0.792156862745098 255.0 111.29629629629635 0.0
        color: 0.796078431372549 255.0 107.59259259259265 0.0
        color: 0.8 255.0 103.88888888888893 0.0
        color: 0.803921568627451 255.0 100.18518518518523 0.0
        color: 0.807843137254902 255.0 96.48148148148154 0.0
        color: 0.8117647058823529 255.0 92.77777777777783 0.0
        color: 0.8156862745098039 255.0 89.0740740740741 0.0
        color: 0.8196078431372549 255.0 85.37037037037041 0.0
        color: 0.8235294117647058 255.0 81.66666666666671 0.0
        color: 0.8274509803921568 255.0 77.96296296296302 0.0
        color: 0.8313725490196079 255.0 74.25925925925941 0.0
        color: 0.8352941176470589 255.0 70.5555555555556 0.0
        color: 0.8392156862745098 255.0 66.8518518518519 0.0
        color: 0.8431372549019608 255.0 63.1481481481482 0.0
        color: 0.8470588235294118 255.0 59.44444444444448 0.0
        color: 0.8509803921568627 255.0 55.74074074074078 0.0
        color: 0.8549019607843137 255.0 52.03703703703709 0.0
        color: 0.8588235294117647 255.0 48.333333333333385 0.0
        color: 0.8627450980392157 255.0 44.62962962962966 0.0
        color: 0.8666666666666667 255.0 40.92592592592597 0.0
        color: 0.8705882352941177 255.0 37.22222222222227 0.0
        color: 0.8745098039215686 255.0 33.518518518518576 0.0
        color: 0.8784313725490196 255.0 29.81481481481485 0.0
        color: 0.8823529411764706 255.0 26.11111111111115 0.0
        color: 0.8862745098039215 255.0 22.407407407407455 0.0
        color: 0.8901960784313725 254.77272727272734 18.703703703703756 0.0
        color: 0.8941176470588236 250.22727272727295 15.000000000000146 0.0
        color: 0.8980392156862745 245.68181818181824 11.296296296296335 0.0
        color: 0.9019607843137255 241.1363636363637 7.592592592592638 0.0
        color: 0.9058823529411765 236.59090909090915 3.8888888888889412 0.0
        color: 0.9098039215686274 232.04545454545462 0.18518518518521598 0.0
        color: 0.9137254901960784 227.50000000000006 0.0 0.0
        color: 0.9176470588235294 222.9545454545455 0.0 0.0
        color: 0.9215686274509803 218.40909090909096 0.0 0.0
        color: 0.9254901960784314 213.8636363636364 0.0 0.0
        color: 0.9294117647058824 209.31818181818187 0.0 0.0
        color: 0.9333333333333333 204.7727272727273 0.0 0.0
        color: 0.9372549019607843 200.22727272727278 0.0 0.0
        color: 0.9411764705882353 195.68181818181822 0.0 0.0
        color: 0.9450980392156862 191.13636363636368 0.0 0.0
        color: 0.9490196078431372 186.59090909090915 0.0 0.0
        color: 0.9529411764705882 182.0454545454546 0.0 0.0
        color: 0.9568627450980393 177.50000000000017 0.0 0.0
        color: 0.9607843137254902 172.95454545454547 0.0 0.0
        color: 0.9647058823529412 168.40909090909093 0.0 0.0
        color: 0.9686274509803922 163.86363636363637 0.0 0.0
        color: 0.9725490196078431 159.31818181818184 0.0 0.0
        color: 0.9764705882352941 154.77272727272728 0.0 0.0
        color: 0.9803921568627451 150.22727272727272 0.0 0.0
        color: 0.984313725490196 145.6818181818182 0.0 0.0
        color: 0.9882352941176471 141.13636363636363 0.0 0.0
        color: 0.9921568627450981 136.5909090909091 0.0 0.0
        color: 0.996078431372549 132.04545454545453 0.0 0.0
        `
        this.cachedLoopData = []
    }

    init(renderer) {
        this.renderer = renderer;
        const verts = VertexDataGenerator.generateData(this.archive, this.product, this.getColormap(this.product))
        this.vertCount = verts.length / 6;
        this.vertsBuffer = new GLBuffer(renderer.gl, renderer.gl.ARRAY_BUFFER);
        this.vertsBuffer.bind()
        this.vertsBuffer.uploadData(verts);
        //verts = null;
    }


    setProduct(prod) {
        this.product = prod;
        const verts = VertexDataGenerator.generateData(this.archive, this.product, this.getColormap(this.product))
        this.vertCount = verts.length / 6;
        this.vertsBuffer.bind()
        this.vertsBuffer.uploadData(verts);
    }

    updateData(newData) {
        this.archive = newData;
        this.setProduct(this.product);
    }

    uploadLoopData(archive) {
        const data = {
            REF: new GLBuffer(this.renderer.gl, this.renderer.gl.ARRAY_BUFFER).bind().uploadData(VertexDataGenerator.generateData(archive, "REF", this.getColormap("REF"))),
            VEL: new GLBuffer(this.renderer.gl, this.renderer.gl.ARRAY_BUFFER).bind().uploadData(VertexDataGenerator.generateData(archive, "VEL", this.getColormap("VEL"))),
            RHO: new GLBuffer(this.renderer.gl, this.renderer.gl.ARRAY_BUFFER).bind().uploadData(VertexDataGenerator.generateData(archive, "RHO", this.getColormap("RHO")))
        }
        this.cachedLoopData.push(data);
        if(this.cachedLoopData > 5) {
            this.cachedLoopData.pop();
        }
    }

    setLoopIndex(index, prod) {
        this.vertsBuffer = this.cachedLoopData[index][prod];
        //this.vertsBuffer = new GLBuffer(this.renderer.gl, this.renderer.gl.ARRAY_BUFFER);
        this.vertsBuffer.bind()
        //this.vertsBuffer.uploadData(data);
        this.vertCount = this.vertsBuffer.vertCount;
    }

    /**
     * 
     * @param {*} cam 
     * @param {Renderer} renderer 
     */
    render(cam, renderer) {
        renderer.drawBuffer(cam, this.vertsBuffer, this.vertCount)
    }

    getColormap(product) {
        switch (product) {
            case "REF":
                return new Colormap(this.refColor);
            case "VEL":
                return new Colormap(this.velColor);
            case "RHO":
                return new Colormap(this.corColor)
            default:
                return new Colormap(this.refColor);
        }
    }
}